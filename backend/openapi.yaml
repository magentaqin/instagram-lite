openapi: 3.0.3
info:
  title: Instagram-lite API
  version: 0.1.0
  description: Minimal API for an Instagram-like feed (anonymous, no auth).

servers:
  - url: http://localhost:8080

paths:
  /api/v1/uploads:
    post:
      summary: Upload an image and return its public URL
      description: |
        Uploads an image via multipart/form-data.
        The server center-crops to a square and resizes to 512x512, then stores it in S3-compatible object storage.
        Returns the public image URL.
      operationId: uploadImage
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
            encoding:
              file:
                contentType: image/jpeg, image/png
      responses:
        "201":
          description: Uploaded successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UploadResponse"
              examples:
                success:
                  value:
                    image_url: "https://instagram-lite-images.fra1.cdn.digitaloceanspaces.com/uploads/01JH8ZK9Q6R6YB8Z5Y0S8R4WQ2.jpg"
        "400":
          description: Invalid request (missing file, unsupported type, decode failed)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                invalid:
                  value:
                    error: "invalid image"
        "413":
          description: File too large
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                tooLarge:
                  value:
                    error: "file too large"
        "502":
          description: Storage provider error (e.g., Spaces/S3 upload failure)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                storageError:
                  value:
                    error: "upload to storage failed"

  /api/v1/posts:
    post:
      summary: Create a post
      description: |
        Creates a post referencing an existing image_url (typically returned by POST /uploads).
        Anonymous (no auth). Tags are optional; server may normalize tags (trim/lowercase/dedupe).
      operationId: createPost
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreatePostRequest"
            examples:
              example:
                value:
                  title: "My first post"
                  image_url: "https://instagram-lite-images.fra1.cdn.digitaloceanspaces.com/uploads/01JH8ZK9Q6R6YB8Z5Y0S8R4WQ2.jpg"
                  tags: ["anime", "cute", "healing"]
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PostResponse"
              examples:
                created:
                  value:
                    post:
                      id: "01JH8ZQZP4V2W3G0M2XQ4Z8Y6A"
                      title: "My first post"
                      image_url: "https://instagram-lite-images.fra1.cdn.digitaloceanspaces.com/uploads/01JH8ZK9Q6R6YB8Z5Y0S8R4WQ2.jpg"
                      tags: ["anime", "cute", "healing"]
                      created_at: "2026-01-17T13:58:12Z"
        "400":
          description: Validation error (missing fields, invalid URL, etc.)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                badRequest:
                  value:
                    error: "title is required"
        "500":
          description: Server/database error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                dbError:
                  value:
                    error: "db error"
    get:
      summary: List posts (infinite scroll)
      description: >
        Returns posts ordered by newest first. Supports cursor-based pagination and optional
        fuzzy tag filtering.
      tags:
        - Posts
      parameters:
        - name: cursor
          in: query
          description: >
            Opaque pagination cursor from a previous response (next_cursor). If omitted, returns the first page.
          required: false
          schema:
            type: string
          example: "eyJjcmVhdGVkX2F0IjoiMjAyNi0wMS0xOFQxNDowMDowMC4wMDBaIiwiZGJfaWQiOjEyM30="
        - name: limit
          in: query
          description: Number of items to return. Defaults to 20. Max 50.
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 20
          example: 20
        - name: tag
          in: query
          description: >
            Optional tag filter (fuzzy match). Example: "cat" matches tags containing "cat".
          required: false
          schema:
            type: string
            minLength: 1
            maxLength: 32
          example: "cat"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListPostsResponse"
              example:
                items:
                  - id: "01KF6R33JQQS24SHNX1BSMG462"
                    title: "My first post"
                    image_url: "https://instagram-lite-images.fra1.cdn.digitaloceanspaces.com/uploads/01KF6R33JQQS24SHNX1BSMG462.jpg"
                    tags: ["cat", "cute"]
                    created_at: "2026-01-18T14:00:00Z"
                  - id: "01KF6R40Y3K3KZ2J2Q9FQG3JZP"
                    title: "Another post"
                    image_url: "https://instagram-lite-images.fra1.cdn.digitaloceanspaces.com/uploads/01KF6R40Y3K3KZ2J2Q9FQG3JZP.jpg"
                    tags: []
                    created_at: "2026-01-18T13:55:12Z"
                next_cursor: "eyJjcmVhdGVkX2F0IjoiMjAyNi0wMS0xOFQxMzo1NToxMi4wMDBaIiwiZGJfaWQiOjEyMX0="
                has_more: true
        "400":
          description: Invalid query parameters
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "invalid limit"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "internal server error"
components:
  schemas:
    UploadResponse:
      type: object
      required: [image_url]
      properties:
        image_url:
          type: string
          format: uri
          description: Public URL to the processed (512x512) image stored in object storage.

    CreatePostRequest:
      type: object
      required: [title, image_url]
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        image_url:
          type: string
          format: uri
          description: The URL returned by POST /uploads.
        tags:
          type: array
          maxItems: 10
          items:
            type: string
            minLength: 1
            maxLength: 32

    PostResponse:
      type: object
      required: [post]
      properties:
        post:
          $ref: "#/components/schemas/Post"

    Post:
      type: object
      required: [id, title, image_url, tags, created_at]
      properties:
        id:
          type: string
        title:
          type: string
        image_url:
          type: string
          format: uri
        tags:
          type: array
          items:
            type: string
        created_at:
          type: string
          format: date-time
    ListPostsResponse:
      type: object
      required: [items, next_cursor, has_more]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/Post"
        next_cursor:
          type: string
          nullable: true
          description: Cursor to fetch the next page. Null when no more results.
          example: "eyJjcmVhdGVkX2F0IjoiMjAyNi0wMS0xOFQxMzo1NToxMi4wMDBaIiwiZGJfaWQiOjEyMX0="
        has_more:
          type: boolean
          example: true

    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: string